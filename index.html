<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>electricity statistics</title>
  <style>
    body {
      margin: 0;
      padding: 10px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      line-height: 1.5;
      background: #fafafa;
    }
    #container {
      width: 100%;
      height: 300px;
    }
    #table-container {
      width: 100%;
      overflow-x: auto; /* 小屏幕可以横向滚动 */
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background: #f5f5f5;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background: #fafafa;
    }
    @media (max-width: 480px) {
      body {
        font-size: 12px;
        padding: 5px;
      }
      #container {
        height: 220px;
      }
      table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <div id="table-container"></div>

  <script src="https://cdn.jsdmirror.com/npm/@antv/g2plot@2.4.35/dist/g2plot.min.js"></script>
  <script src="./data.js"></script>
  <script>
    const { Line } = G2Plot;
    const PRICE = 0.61; // 电价

    const linePlot = new Line('container', {
      data,
      xField: 'time',
      yField: 'kWh',
      useDeferredLabel: true,
      autoFit: true,
      legend: { position: 'top' },
      connectNulls: false,
      slider: { start: 0, end: 1 },
    });
    linePlot.render();

    // ---------------- 表格 ----------------
    const tableContainer = document.getElementById('table-container');
    const table = document.createElement('table');

    // 表头
    const headerRow = document.createElement('tr');
    const headers = ['日期', '用电量 (kWh)', '电费 (元)'];
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      headerRow.appendChild(th);
    });
    table.appendChild(headerRow);

    const last8Days = data.slice(-8).reverse();
    let total7Days = 0;
    let totalCost7Days = 0;

    // 逐日数据
    for (let i = 0; i < last8Days.length - 1; i++) {
      const today = last8Days[i];
      const yesterday = last8Days[i + 1];

      const row = document.createElement('tr');

      // 日期
      const dateCell = document.createElement('td');
      dateCell.textContent = yesterday.time;
      row.appendChild(dateCell);

      // 用电量
      let usage = yesterday.kWh - today.kWh;
      let isCharging = usage < 0;
      const kWhCell = document.createElement('td');
      kWhCell.textContent = isCharging ? `充电` : `${usage.toFixed(2)}`;
      row.appendChild(kWhCell);

      // 电费
      const costCell = document.createElement('td');
      if (isCharging) {
        costCell.textContent = '-';
      } else {
        const cost = usage * PRICE;
        costCell.textContent = cost.toFixed(2);
        total7Days += usage;
        totalCost7Days += cost;
      }
      row.appendChild(costCell);

      table.appendChild(row);
    }

    // 7日合计
    const totalRow7Days = document.createElement('tr');
    totalRow7Days.innerHTML = `<td><b>近7日合计</b></td>
                               <td><b>${total7Days.toFixed(2)}</b></td>
                               <td><b>${totalCost7Days.toFixed(2)}</b></td>`;
    table.appendChild(totalRow7Days);

    // 通用合计函数
    const calcTotalUsage = (days) => {
      const period = data.slice(-days);
      let totalUsage = 0;
      for (let i = 1; i < period.length; i++) {
        let usage = period[i - 1].kWh - period[i].kWh;
        if (usage > 0) totalUsage += usage;
      }
      return totalUsage;
    };

    const addTotalRow = (label, usage) => {
      const cost = usage * PRICE;
      const row = document.createElement('tr');
      row.innerHTML = `<td><b>${label}</b></td>
                       <td><b>${usage.toFixed(2)}</b></td>
                       <td><b>${cost.toFixed(2)}</b></td>`;
      table.appendChild(row);
    };

    addTotalRow('近30日合计', calcTotalUsage(30));
    addTotalRow('近三月合计', calcTotalUsage(90));

    tableContainer.appendChild(table);
  </script>
</body>
</html>
